{% extends 'layouts/ui-base.html' %}

{% block headScripts %}
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
{% endblock headScripts %}

{% block content %}
<h1>Control Panel</h1>

<div id="match-controls">
    <h2>Set Current Match</h2>
    <div>
        <button data-weight="ANT">Antweight</button>
        <button data-weight="PLANT">Plastic Ant</button>
        <button data-weight="BEETLE">Beetleweight</button>
    </div>
    <div>

        <select data-select="red" name="red-robot-select" id="red-robot-select"></select>
        <select data-select="blue" name="blue-robot-select" id="blue-robot-select"></select>
        <button id="create-match">Set Match</button>
    </div>
</div>

<div id="time-controls">
    <h2>Time Controls</h2>
    <button id="reset-time">Reset Timer</button>
    <label for="time-input">Seconds to Add</label>
    <input type="number" id="time-input">
    <button id="increment-time">Add Time</button>
</div>


{% endblock %}

{% block bodyScripts %}
<script type="module">
    import { getRobotList, getLatestMatch, postNewMatch } from '/static/scripts/utilities.js';
    import mqtt_client from '/static/lib/u8-mqtt/esm/web/v5.js';
    let my_mqtt = mqtt_client()
        .with_websock('wss://test.mosquitto.org:8081')
        .with_autoreconnect()

    await my_mqtt.connect();

    const robotDropdowns = document.querySelectorAll('[data-select]');
    const weightBtns = document.querySelectorAll('[data-weight]');
    const createMatchBtn = document.getElementById('create-match');

    const resetTimeBtn = document.getElementById('reset-time');
    const incrementTimeBtn = document.getElementById('increment-time');
    const timeInput = document.getElementById('time-input');

    resetTimeBtn.addEventListener('click', () => {
        my_mqtt.send('timecontrol', 'r');
    });
    incrementTimeBtn.addEventListener('click', () => {
        my_mqtt.send('timecontrol', `a${timeInput.value}`);
    })

    let activeWeight = null;

    const optionSets = {}

    weightBtns.forEach(btn => {
        // populate the option sets
        let weight = btn.dataset.weight;
        optionSets[weight] = '';
        getRobotList(weight)
            .then(robotList => {
                robotList.forEach(robot => {
                    let { robot_name, id } = robot;
                    let opt = `<option value="${id}">${robot_name}</option>`
                    optionSets[weight] += opt;
                })
            })
            // .finally(() => console.log(optionSets));

        // create event listeners on the weight buttons to populate the dropdowns with the auto-generated options
        btn.addEventListener('click', () => {
            let weight = btn.dataset.weight;
            activeWeight = weight;
            robotDropdowns.forEach(dropdown => {
                dropdown.innerHTML = optionSets[weight];
            })
        });
    });

    createMatchBtn.addEventListener('click', () => {
        let red = document.getElementById('red-robot-select').value;
        let blue = document.getElementById('blue-robot-select').value;
        postNewMatch(red, blue, activeWeight)
    });
</script>
{% endblock bodyScripts %}