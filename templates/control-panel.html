{% extends 'layouts/ui-base.html' %}

{% block headScripts %}
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
{% endblock headScripts %}

{% block content %}

<div class="ui stackable padded grid">
    
    <div class="twelve wide column">
        <div class="ui segment raised">
            <h2 class="ui dividing header">Match Setup</h2>

            <div class="ui form">

                <div class="three fields">
                    <div class="field">

                        <button class="ui fluid button" data-weight="ANT">Antweight</button>
                    </div>
                    <div class="field">

                        <button class="ui fluid button" data-weight="PLANT">Plastic Ant</button>
                    </div>
                    <div class="field">

                        <button class="ui fluid button" data-weight="BEETLE">Beetleweight</button>
                    </div>

                </div>

                <div class="two fields">

                    <div class="field">
                        <div class="ui labeled input">
                            <label for="red-robot-select" class="ui red label">Red</label>
                            <select data-select="red" name="red-robot-select" id="red-robot-select"></select>
                        </div>

                    </div>
                    <div class="field">
                        <div class="ui labeled input">
                            <label class="ui blue label">Blue</label>
                            <select data-select="blue" name="blue-robot-select" id="blue-robot-select"></select>
                        </div>

                    </div>
                </div>

                <button id="create-match" class="ui fluid button">Create Match</button>
            </div>
        </div>
    </div>
    
    <div class="four wide column">
        <div class="ui segment raised">
            <h2 class="ui dividing header">Time Control</h2>
            <div class="ui form">
                <div class="field">

                    <button class="ui fluid button" id="timer-reset">Reset</button>
                </div>
                <div class="field">


                    <div class="ui fluid action input">
                        <input type="number" name="inc-time" id="inc-time" placeholder="...">
                        <button class="ui button">Add</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="twelve wide column">
        <div class="ui segment raised">
            <h2 class="ui dividing header">Match Results</h2>
            <div class="ui form">
                <div class="three fields">
                    <div class="field">
                        <button class="ui fluid button" data-result="JUDGE">Judge</button>
                    </div>
                    <div class="field">
                        <button class="ui fluid button" data-result="KO">Knockout</button>
                    </div>
                    <div class="field">
                        <button class="ui fluid button" data-result="TO">Tapout</button>
                    </div>
                </div>

                <div class="three fields">
                    <div class="field">
                        <buttton class="ui fluid red button" data-winner="red">Red</buttton>
                    </div>
                    <div class="field">
                        <buttton class="ui fluid blue button" data-winner="blue">Blue</buttton>
                    </div>
                    <div class="field">
                        <button class="ui fluid basic button" data-winner="undetermined">Undetermined</button>
                    </div>
                </div>
                <button class=" ui fluid button" id="update-result-type">Update</button>

            </div>

        </div>

    </div>


</div>


{% endblock %}

{% block bodyScripts %}

<script type="module">

    // imports
    import { getRobotList, getLatestMatch, postNewMatch } from '/static/scripts/utilities.js';
    import mqtt_client from '/static/lib/u8-mqtt/esm/web/v5.js';

    // MQTT setup
    let my_mqtt = mqtt_client()
        .with_websock('wss://test.mosquitto.org:8081')
        .with_autoreconnect()
    await my_mqtt.connect();

    const robotDropdowns = document.querySelectorAll('[data-select]');
    const weightBtns = document.querySelectorAll('[data-weight]');
    const createMatchBtn = document.getElementById('create-match');

    const resetTimeBtn = document.getElementById('reset-time');
    const incrementTimeBtn = document.getElementById('increment-time');
    const timeInput = document.getElementById('time-input');

    const resultTypeRadios = document.getElementsByName('result-type');
    const resultTypeUpdate = document.getElementById('update-result-type');
    const resultTypeClear = document.getElementById('clear-result-type');

    resultTypeUpdate.addEventListener('click', () => {
        let selected = null;
        resultTypeRadios.forEach(radio => {
            if (radio.checked) {
                selected = radio.value;
            }
        })
        console.log(selected);
    });
    resultTypeClear.addEventListener('click', () => {
        resultTypeRadios.forEach(radio => radio.checked = false);
    });

    const winnerRadios = document.getElementsByName('winner-radio');
    const winnerUpdate = document.getElementById('update-winner');
    const winnerClear = document.getElementById('clear-winner');

    winnerUpdate.addEventListener('click', () => {
        let selected = null;
        winnerRadios.forEach(radio => {
            if (radio.checked) {
                selected = radio.value;
            }
        })
        console.log(selected);
    });
    winnerClear.addEventListener('click', () => {
        winnerRadios.forEach(radio => radio.checked = false);
    });

    resetTimeBtn.addEventListener('click', () => {
        my_mqtt.send('timecontrol', 'r');
    });
    incrementTimeBtn.addEventListener('click', () => {
        my_mqtt.send('timecontrol', `a${timeInput.value}`);
    })

    let activeWeight = null;

    const optionSets = {}

    weightBtns.forEach(btn => {
        // populate the option sets
        let weight = btn.dataset.weight;
        optionSets[weight] = '';
        getRobotList(weight)
            .then(robotList => {
                robotList.forEach(robot => {
                    let { robot_name, id } = robot;
                    let opt = `<option value="${id}">${robot_name}</option>`
                    optionSets[weight] += opt;
                })
            })
        // .finally(() => console.log(optionSets));

        // create event listeners on the weight buttons to populate the dropdowns with the auto-generated options
        btn.addEventListener('click', () => {
            let weight = btn.dataset.weight;
            activeWeight = weight;
            robotDropdowns.forEach(dropdown => {
                dropdown.innerHTML = optionSets[weight];
            })
        });
    });

    createMatchBtn.addEventListener('click', () => {
        let red = document.getElementById('red-robot-select').value;
        let blue = document.getElementById('blue-robot-select').value;
        postNewMatch(red, blue, activeWeight)
    });
</script>
{% endblock bodyScripts %}